version: '3'

env:
  COMPOSE_FILE: docker-compose.yml
  MLFLOW_TRACKING_URI: http://mlflow:5000

tasks:
  build:
    desc: "ğŸ› ï¸ Build des images Docker"
    cmds:
      - docker compose -f $COMPOSE_FILE build

  up:
    desc: "ğŸš€ Lancer tous les services (API, MLflow, Prometheus, Grafana)"
    cmds:
      - docker compose -f $COMPOSE_FILE up -d

  down:
    desc: "ğŸ›‘ ArrÃªter tous les services"
    cmds:
      - docker compose -f $COMPOSE_FILE down

  restart:
    desc: "â™»ï¸ RedÃ©marrer tous les services"
    cmds:
      - task down
      - task up

  logs:
    desc: "ğŸ“„ Voir les logs de tous les services"
    cmds:
      - docker compose -f $COMPOSE_FILE logs -f --tail=50

  api:
    desc: "ğŸ” RedÃ©marrer uniquement lâ€™API"
    cmds:
      - docker compose -f $COMPOSE_FILE restart api

  mlflow:
    desc: "ğŸ“Š Lancer seulement le serveur MLflow"
    cmds:
      - docker compose -f $COMPOSE_FILE up -d mlflow

  grafana:
    desc: "ğŸ“ˆ Lancer seulement Grafana"
    cmds:
      - docker compose -f $COMPOSE_FILE up -d grafana

  prometheus:
    desc: "ğŸ” Lancer seulement Prometheus"
    cmds:
      - docker compose -f $COMPOSE_FILE up -d prometheus

  clean:
    desc: "ğŸ§¹ Supprimer tous les containers et volumes"
    cmds:
      - docker compose -f $COMPOSE_FILE down -v --remove-orphans

  clean-all:
    desc: "ğŸ§¨ Supprimer tous les conteneurs, volumes et images non utilisÃ©es"
    cmds:
      - docker compose -f $COMPOSE_FILE down -v --remove-orphans
      - docker image prune -f

  status:
    desc: "ğŸ“Œ Voir lâ€™Ã©tat de tous les containers"
    cmds:
      - docker compose -f $COMPOSE_FILE ps

  shell-api:
    desc: "ğŸ’» Ouvrir un shell dans le conteneur API"
    cmds:
      - docker compose -f $COMPOSE_FILE exec api sh

  show-env:
    desc: "ğŸ” Afficher les variables dâ€™environnement courantes"
    cmds:
      - printenv | grep -E 'MLFLOW|ENV_MODE|API'

  test:
    desc: "ğŸ§ª Lancer les tests (Docker)"
    deps: [build]
    cmds:
      - docker compose -f $COMPOSE_FILE run --rm api pytest

  debug:
    desc: "ğŸ” Debug: containers + ports"
    cmds:
      - docker ps
      - docker compose -f $COMPOSE_FILE ps
      - docker compose -f $COMPOSE_FILE logs --tail=30

  reload-env:
    desc: "â™»ï¸ Recharger les fichiers .env dans les conteneurs (down + up)"
    cmds:
      - task down
      - task up
